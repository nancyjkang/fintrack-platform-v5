#!/usr/bin/env sh

echo "ğŸš€ FinTrack v5 Pre-push checks starting..."

# CRITICAL: Production build check (moved from pre-commit for faster commits)
echo "ğŸ” Checking production build..."
npm run build > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "ğŸš« PUSH REJECTED: Production build failed"
  echo "ğŸ’¡ Run 'npm run build' to see detailed errors"
  echo "ğŸ’¡ Build must pass before pushing to ensure deployable code"
  exit 1
fi
echo "âœ… Production build passed"

# TypeScript compilation double-check
echo "ğŸ” Final TypeScript compilation check..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "ğŸš« PUSH REJECTED: TypeScript compilation failed"
  echo "ğŸ’¡ Fix TypeScript errors before pushing"
  exit 1
fi
echo "âœ… TypeScript compilation passed"

# Mock data detection check (excluding test files)
echo "ğŸ” Checking for mock data and TODO comments..."
MOCK_FILES=$(grep -r -l --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
  --exclude-dir="__tests__" --exclude="*.test.*" --exclude="*.spec.*" \
  -e "Mock.*data" \
  -e "mock.*=" \
  -e "will be replaced" \
  -e "TODO.*replace" \
  -e "hardcoded.*data" \
  -e "fake.*data" \
  src/ 2>/dev/null || true)

if [ ! -z "$MOCK_FILES" ]; then
  echo "ğŸš« PUSH REJECTED: Mock data or TODO comments found in:"
  echo "$MOCK_FILES"
  echo ""
  echo "ğŸ’¡ Found suspicious patterns that may indicate mock data:"
  grep -n --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" \
    --exclude-dir="__tests__" --exclude="*.test.*" --exclude="*.spec.*" \
    -e "Mock.*data" \
    -e "mock.*=" \
    -e "will be replaced" \
    -e "TODO.*replace" \
    -e "hardcoded.*data" \
    -e "fake.*data" \
    $MOCK_FILES 2>/dev/null || true
  echo ""
  echo "ğŸ’¡ Please replace mock data with real API calls before pushing"
  exit 1
fi
echo "âœ… No mock data patterns detected"

# ESLint check
echo "ğŸ” Running ESLint checks..."
npm run lint
if [ $? -ne 0 ]; then
  echo "ğŸš« PUSH REJECTED: ESLint errors found"
  echo "ğŸ’¡ Fix linting errors before pushing"
  exit 1
fi
echo "âœ… ESLint checks passed"

# Full test suite
echo "ğŸ” Running complete test suite..."
npm run test
if [ $? -ne 0 ]; then
  echo "ğŸš« PUSH REJECTED: Test suite failed"
  echo "ğŸ’¡ Fix failing tests before pushing"
  exit 1
fi
echo "âœ… Test suite passed"

# Security audit
echo "ğŸ” Running security audit..."
npm audit --audit-level=moderate --silent
if [ $? -ne 0 ]; then
  echo "ğŸš« PUSH REJECTED: Security vulnerabilities found"
  echo "ğŸ’¡ Run 'npm audit fix' to fix security issues"
  exit 1
fi
echo "âœ… Security audit passed"

echo "âœ… All pre-push checks passed! Safe to deploy ğŸš€"
