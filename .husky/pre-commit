#!/usr/bin/env sh

echo "ğŸ” FinTrack v5 Pre-commit checks starting..."


# Basic code quality checks for v5
echo "ğŸ” Running basic code quality checks..."

echo "ğŸ” Checking CSS syntax..."

# Check CSS syntax for staged CSS files
CSS_FILES=$(git diff --cached --name-only | grep -E '\.(css|scss|sass)$' 2>/dev/null || true)
if [ -n "$CSS_FILES" ]; then
  for css_file in $CSS_FILES; do
    if [ -f "$css_file" ]; then
      # Check for common CSS syntax errors
      if grep -q "^[[:space:]]*\.[[:space:]]*$" "$css_file"; then
        echo "âŒ CSS syntax error detected in $css_file!"
        echo "   Found stray dot character on line(s):"
        grep -n "^[[:space:]]*\.[[:space:]]*$" "$css_file" | sed 's/^/     /'
        echo ""
        echo "ğŸš« COMMIT REJECTED: Please fix CSS syntax errors before committing"
        exit 1
      fi

      # Check for stray single characters or incomplete CSS
      if grep -q "^[[:space:]]*[a-zA-Z][[:space:]]*$" "$css_file"; then
        echo "âŒ CSS syntax error detected in $css_file!"
        echo "   Found stray single character(s) on line(s):"
        grep -n "^[[:space:]]*[a-zA-Z][[:space:]]*$" "$css_file" | sed 's/^/     /'
        echo ""
        echo "ğŸš« COMMIT REJECTED: Please fix CSS syntax errors before committing"
        exit 1
      fi

      # Check for unmatched braces
      open_braces=$(grep -o '{' "$css_file" | wc -l)
      close_braces=$(grep -o '}' "$css_file" | wc -l)
      if [ "$open_braces" -ne "$close_braces" ]; then
        echo "âŒ CSS syntax error detected in $css_file!"
        echo "   Unmatched braces: $open_braces opening vs $close_braces closing"
        echo ""
        echo "ğŸš« COMMIT REJECTED: Please fix CSS syntax errors before committing"
        exit 1
      fi

      # Check for missing semicolons in property declarations
      if grep -q "^[[:space:]]*[a-zA-Z-][a-zA-Z0-9_-]*[[:space:]]*:[[:space:]]*[^;{]*[[:space:]]*$" "$css_file"; then
        echo "âŒ CSS syntax error detected in $css_file!"
        echo "   Found property declarations without semicolons:"
        grep -n "^[[:space:]]*[a-zA-Z-][a-zA-Z0-9_-]*[[:space:]]*:[[:space:]]*[^;{]*[[:space:]]*$" "$css_file" | sed 's/^/     /'
        echo ""
        echo "ğŸš« COMMIT REJECTED: Please fix CSS syntax errors before committing"
        exit 1
      fi
    fi
  done
  echo "âœ… CSS syntax validation passed"
fi

# CRITICAL: TypeScript compilation check
echo "ğŸ” Checking TypeScript compilation..."
npx tsc --noEmit
if [ $? -ne 0 ]; then
  echo "ğŸš« COMMIT REJECTED: TypeScript compilation failed"
  echo "ğŸ’¡ Fix TypeScript errors before committing"
  exit 1
fi
echo "âœ… TypeScript compilation passed"

# CRITICAL: Date handling ESLint checks (prevent direct Date() usage)
echo "ğŸ” Running date handling compliance checks..."
# Check for direct Date() usage (excluding date-utils.ts and test files which are temporarily allowed)
DATE_VIOLATIONS=$(git diff --cached --name-only | grep -E '\.(ts|tsx)$' | grep -v 'date-utils.ts' | grep -v '__tests__' | grep -v '\.test\.' | grep -v '\.spec\.' | xargs grep -l 'new Date(' 2>/dev/null || true)
if [ -n "$DATE_VIOLATIONS" ]; then
  echo "ğŸš« COMMIT REJECTED: Direct Date() usage found in:"
  for file in $DATE_VIOLATIONS; do
    echo "   - $file"
    grep -n 'new Date(' "$file" | head -3 | sed 's/^/     /'
  done
  echo ""
  echo "ğŸ’¡ Use date utility functions from @/lib/utils/date-utils instead:"
  echo "   - getCurrentUTCDate() for current date"
  echo "   - createUTCDate(year, month, day) for specific dates"
  echo "   - parseAndConvertToUTC(dateString) for parsing dates"
  echo "   - formatDateForDisplay(dateString) for display formatting"
  exit 1
fi
echo "âœ… Date handling compliance passed"

# Build check moved to pre-push hook for faster commits

# CRITICAL: Test suite check (ensures all tests pass)
echo "ğŸ” Running test suite..."
npm run test > /dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "ğŸš« COMMIT REJECTED: Test suite failed"
  echo "ğŸ’¡ Run 'npm run test' to see detailed test failures"
  echo "ğŸ’¡ Fix failing tests before committing"
  exit 1
fi
echo "âœ… Test suite passed"

echo "âœ… All pre-commit checks passed!"
